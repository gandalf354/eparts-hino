name: Deploy
on:
  push:
    branches:
      - main
  workflow_dispatch:
concurrency:
  group: deploy-selfhosted
  cancel-in-progress: true
permissions:
  contents: read
jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Write environment file
        shell: bash
        env:
          ENV_FILE: ${{ secrets.ENV_FILE }}
        run: |
          printf "%s" "$ENV_FILE" > .env
          set -a
          . ./.env || true
          set +a
          mkdir -p "${UPLOADS_DIR:-public/uploads}"
      - name: Deploy with Docker Compose
        shell: bash
        run: bash scripts/deploy.sh rebuild

        
