name: Deploy
on:
  push:
    branches:
      - main
  workflow_dispatch:
concurrency:
  group: deploy-selfhosted
  cancel-in-progress: true
permissions:
  contents: read
jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Write environment file
        shell: bash
        run: |
          mkdir -p public/uploads
          cat > .env <<'EOF'
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_SOCKET=${{ secrets.DB_SOCKET }}
          NODE_ENV=production
          PORT=5174
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }}
          VITE_API_URL=${{ secrets.VITE_API_URL }}
          SEED_CREATE_USERS=${{ secrets.SEED_CREATE_USERS }}
          ADMIN_USER=${{ secrets.ADMIN_USER }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          SUPERADMIN_USER=${{ secrets.SUPERADMIN_USER }}
          SUPERADMIN_PASSWORD=${{ secrets.SUPERADMIN_PASSWORD }}
          DEFAULT_USER=${{ secrets.DEFAULT_USER }}
          DEFAULT_USER_PASSWORD=${{ secrets.DEFAULT_USER_PASSWORD }}
          EOF
      - name: Deploy with Docker Compose
        shell: bash
        run: bash scripts/deploy.sh rebuild
